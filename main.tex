% !TeX encoding = UTF-8 Unicode
\documentclass[a4paper,12pt]{article}
\usepackage[english]{babel}
\usepackage[english]{isodate}
\usepackage{graphicx}
\usepackage{hyperref}
\usepackage{centernot}
\usepackage{xfrac}
\usepackage{mathtools}
\usepackage{enumitem}
\usepackage{fancyhdr}
\usepackage{lastpage}
\usepackage{xcolor}
\usepackage{changepage}
\usepackage{amsthm}
\usepackage{amsfonts}
\usepackage{amsmath}
\usepackage{amssymb}
\usepackage{soul}
\usepackage{float}
\usepackage{centernot}
\usepackage{tcolorbox}
\usepackage{titling}
\usepackage{caption}
\usepackage{subcaption}
\usepackage{etoolbox}
\usepackage{listings}
\usepackage{biblatex}
\usepackage{csquotes}
\usepackage{titlesec}
\usepackage{tikz}

\addbibresource{bibliography.bib}

\patchcmd{\section}{\bfseries}{\bfseries\boldmath }{}{}
\patchcmd{\subsection}{\bfseries}{\bfseries\boldmath }{}{}
\patchcmd{\subsubsection}{\bfseries}{\bfseries\boldmath }{}{}

\hypersetup{
  colorlinks=True,
  urlcolor=blue,
  citecolor=red,
  menucolor=black,
}

\renewcommand{\UrlFont}{\ttfamily\footnotesize}

\lstdefinelanguage{futhark}
{
  % list of keywords
  morekeywords={
    do,
    else,
    for,
    if,
    in,
    include,
    let,
    loop,
    then,
    type,
    val,
    while,
    with,
    module,
    def,
    entry,
    local,
    open,
    import,
    assert,
    match,
    case,
  },
  sensitive=true, % Keywords are case sensitive.
  morecomment=[l]{--}, % l is for line comment.
  morestring=[b]" % Strings are enclosed in double quotes.
}


\lstset{
    language=futhark,
    showspaces=false,
    showstringspaces=false,
    mathescape=true,
    aboveskip=0pt,
    belowskip=6pt,
    numberstyle=\tiny,
    numbers=left, 
    firstnumber=1,
    numberfirstline=true,
    tabsize=4,
    breaklines=true,
}

\newcommand\LAST{\text{LAST}}
\newcommand\defiff{\mathrel{\stackrel{\makebox[0pt]{\mbox{\normalfont\tiny def}}}{\iff}}}
\newcommand\defeq{\mathrel{\stackrel{\makebox[0pt]{\mbox{\normalfont\tiny def}}}{=}}}
\newcommand\concat{\: \mathrlap{+} \: +}
\newcommand\map{\textbf{map}\ }
\newcommand\reduce{\textbf{reduce}\ }
\theoremstyle{definition}
\newtheorem{definition}{Definition}[section]
\newtheorem{proposition}{Proposition}[section]
\newtheorem{corollary}{Corollary}[section]
\newtheorem*{remark}{Remark}
\newtheorem{lemma}{Lemma}[section]
\newtheorem{theorem}{Theorem}
\newtheorem{algorithm}{Algorithm}[section]
\newtheorem{example}{Example}[section]
\DeclareMathOperator{\sign}{sign}
\newcommand\doubleplus{+\kern-1.3ex+\kern0.8ex}
\newcommand\mdoubleplus{\ensuremath{\mathbin{+\mkern-10mu+}}}

\newcommand{\id}[1]{\ensuremath{\mathit{#1}}}
\newcommand{\kw}[1]{\ensuremath{\mathtt{#1}}}
\newcommand{\Let}{\kw{let}}
\newcommand{\In}{\kw{in}}
\newcommand{\If}{\kw{if}}
\newcommand{\Then}{\kw{then}}
\newcommand{\Else}{\kw{else}}
\newcommand{\Filter}{\kw{filter}}
\newcommand{\Or}{\kw{or}}
\newcommand{\Groupby}{\kw{groupby}}
\newcommand{\Partition}{\kw{partition}}
\newcommand{\Scatter}{\kw{scatter}}
\newcommand{\Hist}{\kw{hist}}
\newcommand{\Map}{\kw{map}}
\newcommand{\Sum}{\kw{sum}}
\newcommand{\Mod}{\kw{mod}}
\newcommand{\Fst}{\kw{fst}}
\newcommand{\Snd}{\kw{snd}}
\newcommand{\Presum}{\kw{presum}}
\newcommand{\True}{\kw{true}}
\newcommand{\False}{\kw{false}}
\newcommand{\Sort}{\kw{sort}}
\newcommand{\Segor}{\kw{segor}}
\newcommand{\Hash}{\kw{hash}}
\newcommand{\Random}{\kw{random}}
\newcommand{\Iota}{\kw{iota}}
\newcommand{\Unzip}{\kw{unzip}}
\newcommand{\Unit}{\mathbf{unit}}
\newcommand{\Int}{\mathbf{int}}
\newcommand{\Bool}{\mathbf{bool}}
\newcommand{\Def}{\kw{def}}
\newcommand{\Rep}{\kw{rep}}
\newcommand{\Zip}{\kw{zip}}

\fancyhf{}
\setlength{\headheight}{14.49998pt}
\pretitle{\vspace{-120pt}\begin{center}}
\posttitle{\par\end{center}\vspace{-80pt}}
\fancyhead[C]{}
\fancyfoot[R]{Page \thepage \hspace{1pt} of \pageref{LastPage}}
\pagestyle{fancy}
\fancypagestyle{firstpage}{%
    \fancyhf{}
    \renewcommand{\headrulewidth}{0pt}
    \fancyfoot[R]{Page \thepage \hspace{1pt} of \pageref{LastPage}}
}
\title{
    {\Large \textsc{University of Copenhagen}} \\[5pt]
    {\large Union-Find} \\[10pt]
    Author: William Henrich Due \\[0pt]
}
\author{}
\date{}

\begin{document}
\maketitle
\thispagestyle{firstpage}

\section{Theory}
\begin{definition}[Reachability]
    A node $v$ is \emph{reachable} from a node $u$ in a directed graph $G = (V,
    E)$ if there exists a sequence of directed edges $e_1, e_2, \ldots, e_m \in
    E$ where $m \geq 1$ and $e_i = (v_{i-1}, v_i)$ for $1 \leq i \leq m$,
    such that $v_0 = u$ and $v_m = v$. We denote this by $u \leadsto v$.
\end{definition}

\begin{definition}[Cycle]
    A cycle in a directed graph $G = (V, E)$ has a cycle if there exists
    $v \in V$ such that $v \leadsto v$.
\end{definition}

\begin{definition}[Forest]
    A forest is a directed graph $F = (V, E)$ where $V$ is a set of vertices and $E
    \subseteq V \times V$ is a set of directed edges such that:
    \begin{enumerate}
        \item There are no cycles $v \centernot\leadsto v$ for all $v \in V$, and
        \item each node has at most one parent i.e. for all $(u, v_1), (u, v_2)
        \in E$ it holds that $v_1 = v_2$.
    \end{enumerate}
\end{definition}

\begin{definition}[Root]
    A node $v \in V$ in a forest $F = (V, E)$ is a root if it has no parent.
    This is defined as the predicate:
    \begin{align*}
        \mathcal{R}_F(v) : v \centernot\leadsto u \text{ for all } u \in V
    \end{align*}
\end{definition}

\begin{definition}[Tree]
    A tree is a forest $T = (V, E)$ where there exists a unique root $r \in V$
    such that $v \leadsto r$ for all $v \in V\backslash
    \{r\}$.
\end{definition}

\begin{proposition}[Forest Root Count]\label{prop:forest-root-count}
    A forest $F = (V, E)$ where $|V| = n$ and $|E| = n - k$ has $k$ roots.
\end{proposition}

\begin{proof}
    Let $F = (V, E)$ be a forest where $|V| = n$ and $|E| = n - k$. By the
    second property of a forest then $n - k$ vertices must have a parent. Since
    there are $n$ vertices in total it follows that there are exactly $k$
    vertices $r_1, r_2, \ldots, r_k \in V$ that has no parent. Hence there are
    exactly $k$ roots in $F$.
\end{proof}

\begin{proposition}[Roots Path Exist]\label{prop:roots-path-exist}
    In a forest $F = (V, E)$ for each element $v \in V$ there exists at least
    one root $r \in V$ such that $\mathcal{R}_F(r)$ and either $v \leadsto r$ or
    $v = r$.
\end{proposition}

\begin{proof}
    Let $F = (V, E)$ be a forest and let $v \in V$ be an arbitrary element in
    $V$. By proposition \ref{prop:forest-root-count} there exists at least one
    root $r \in V$ such that $\mathcal{R}_F(r)$. This can be shown by structural
    induction on a vertex $v \in V$ that any $p \in V$ such that $v \leadsto p$
    has a path $p \leadsto r$.
    \begin{itemize}
        \item If $v$ is a root then we are done.
        \item By induction hypothesis $v$ has a path to a root $r \in V$ such
        that $\mathcal{R}_F(r)$. Since $v$ is not a root it must have a parent
        $p \in V$ such that $(v, p) \in E$. Since $v \leadsto r$, $v \leadsto p$
        and $v$ only has one parent it follows that $p \leadsto r$. Hence $p
        \leadsto r$ for some root $r \in V$ such that $\mathcal{R}_F(r)$.
    \end{itemize}
\end{proof}

\begin{proposition}[Forest Edge Limit]\label{prop:forest-edge-limit}
    A forest $F = (V, E)$ where $|V| = n$ and $|E| > n - 1$ is not a forest.
\end{proposition}

\begin{proof}
    Let $F = (V, E)$ be a forest where $|V| = n$ and $|E| > n - 1$. By
    proposition \ref{prop:forest-root-count} a forest with $n - 1$ has exactly
    one root, so it is a tree. By adding one more edge to the tree it must make
    one vertex have two parents. Or since every vertex $v \in V$ has a path to
    the root $r \in V$ it must create a cycle $v \leadsto v$ for some $v \in V$.
    In both cases it contradicts the properties of a forest.
\end{proof}

\begin{definition}[Representative]
    The representative of an element $v \in V$ in a forest $F = (V, E)$ is the
    root $r \in V$ such that there is a path from $v$ to $r$. This is defined as
    the function:
    \begin{align*}
        \rho_F(v) := r \text{ where } r \in V \text{ such that } \mathcal{R}_F(r) \land (v \leadsto r \lor v = r)
    \end{align*}
\end{definition}

\begin{proposition}[Unique Representative]
    In a forest $F = (V, E)$ each element $v \in V$ has a unique
    representative $\rho_F(v)$.
\end{proposition}

\begin{proof}
    Let $F = (V, E)$ be a union-find structure and let $v \in V$ be an arbitrary
    element in $V$. By proposition \ref{prop:roots-path-exist} there exists at
    least one root $r \in V$ such that $\mathcal{R}_F(r)$ and $v \leadsto r$.
    Now assume that there exists another root $r' \in V$ such that $\mathcal{R}_F(r')$
    and $v \leadsto r'$. Since $F$ is a forest it follows by the second property
    of a forest that $r = r'$ hence the representative is unique.
\end{proof}

\begin{definition}[Tree Set]
    The set of vertices of the same tree $\mathcal{E}_F(v)$ in a
    forest $F = (V, E)$ is defined as:
    \begin{align*}
        \mathcal{E}_F(v) := \{u : u \in V \text{ where } \rho_F(u) = \rho_F(v))\}
    \end{align*}
\end{definition}

\begin{definition}[Partition]\label{def:partition}
    The set $P \subseteq \mathbb{P}(S)$ is a partition of a set $S$ if:
    \begin{enumerate}
        \item $a \neq \emptyset$ for all $a \in P$
        \item $a \cap b = \emptyset$ for all $a, b \in P$ where $a
        \neq b$
        \item $\bigcup_{a \in P} a = S$
    \end{enumerate}
\end{definition}

\begin{proposition}[Forest Partition]\label{prop:forest-partition}
    A forest $F = (V, E)$ is a partition of $V$ for the following set:
    \begin{align*}
        \{\mathcal{E}_F(v) : v \in V\}
    \end{align*}
\end{proposition}

\begin{proof}
    Let $F = (V, E)$ be a forest. We will show that the set in the proposition
    is a partition of $V$ by showing that it satisfies the three properties in
    definition \ref{def:partition}.
    \begin{enumerate}
        \item By definition of $\mathcal{E}_F(v)$ it can not be empty since for
        $\mathcal{E}_F(v)$ then $\rho_F(v) = \rho_F(v)$. Hence $\mathcal{E}_F(v)
        \neq \emptyset$ for all $v \in V$.
        \item Let $a$ and $b$ be two arbitrary elements in the set such that $a
        \neq b$. By definition of $a$ and $b$ there exists $v_1, v_2 \in V$ such
        that $a = \{u : u \in V \land \rho_F(u) = \rho_F(v_1)\}$ and $b = \{u :
        u \in V \land \rho_F(u) = \rho_F(v_2)\}$. Since $a \neq b$ it follows
        that $\rho_F(v_1) \neq \rho_F(v_2)$ since otherwise $a = b$, hence $a
        \cap b = \emptyset$.
        \item Let $v$ be an arbitrary element in $V$. By proposition
        \ref{prop:roots-path-exist} there exists a root $r \in V$ such that
        $\mathcal{R}_F(r)$ and $v \leadsto r$ or $v = r$. By definition of the
        representative it follows that $\rho_F(v) = r$. Now let $a = \{u : u \in
        V \land \rho_F(u) = \rho_F(v)\}$. By definition of $a$ it follows that
        $v \in a$. Since $v$ was arbitrary it follows that $\bigcup_{a \in P} a
        = V$.
    \end{enumerate}
\end{proof}

\begin{definition}[Same Tree Relation]
    The relation $\sim_F$ on a forest $F$ is defined as:
    \begin{align*}
        u \sim_F v :\iff u \in \mathcal{E}_F(v)
    \end{align*}
\end{definition}

\begin{corollary}[Same Tree Relation is an Equivalence Relation]
    The relation $\sim_F$ on a forest $F$ is an equivalence relation due to
    $\{\mathcal{E}_F(v) : v \in V\}$ being a partition of $V$. by proposition
    \ref{prop:forest-partition}.
\end{corollary}

\begin{definition}[Forests with Equivalent Tree Sets]
    Two forests $F = (V, E)$ and $F' = (V', E')$ have equivalent tree sets $F
    \cong F'$ if:
    \begin{itemize}
        \item Vertices are the same $V = V'$.
        \item The tree sets are equivalent $\mathcal{E}_{F}(v) =
        \mathcal{E'}_F(v)$ for all $v \in V$.
    \end{itemize}
\end{definition}

\begin{definition}[Tree Union]
    The tree union of two elements $v$ and $u$ for a forest $F = (V, E)$ is such
    that $v \sim_{F'} u$ in a new forest $F' = (V', E')$ and $F'$ satify the
    following properties:
    \begin{enumerate}
        \item $\mathcal{E}_{F'}(v) = \mathcal{E}_{F'}(u) = \mathcal{E}_F(v) \cup \mathcal{E}_F(u)$ and
        \item $\mathcal{E}_{F'}(w) = \mathcal{E}_F(w) \text{ for all } w \in V
        \backslash (\mathcal{E}_F(v) \cup \mathcal{E}_F(u))$.
    \end{enumerate}
\end{definition}

\begin{proposition}[Tree Union]\label{def:tree-union}
    Let forest $F = (V, E)$, $p = \rho_F(u)$ be the representative of $u$ and
    let $q = \rho_F(v)$ be the representative of $v$ where $q \neq p$. Then
    defined $F'$ as:
    \begin{align*}
        F' &:= (V, E \cup \{(q, p)\})
    \end{align*}
    Then $u \sim_{F'} v$ in $F'$ and $F'$ will satisfy the properties of a tree
    union.
\end{proposition}

\begin{proof}
    Let $F = (V, E)$, $p = \rho_F(u)$ be the representative of $u$ and let $q =
    \rho_F(v)$ be the representative of $v$. By definition $q$ will have parent
    $p$ in $F'$ and since $q$ is a root it has no parent then $F'$ is a forest.
    Now for all $w \in \mathcal{E}_F(q)$ it holds that $w \leadsto q$ or $q = w$
    and since $q \leadsto p$ it follows that $w \leadsto p$. Hence $w \in
    \mathcal{E}_{F'}(p)$ for all $w \in \mathcal{E}_F(q)$ and trivially $w \in
    \mathcal{E}_{F'}(p)$ for all $w \in \mathcal{E}_F(p)$ so it follows that
    $\mathcal{E}_{F'}(v) = \mathcal{E}_{F'}(u) = \mathcal{E}_F(v) \cup
    \mathcal{E}_F(u)$. Now let $w \in V \backslash (\mathcal{E}_F(v) \cup
    \mathcal{E}_F(u))$ be an arbitrary element. Since $w \centernot\leadsto p$,
    $w \neq p$, $w \centernot\leadsto q$, and $w \neq q$ it follows that $w$ has
    the same representative in $F'$ as in $F$ hence $\mathcal{E}_{F'}(w) =
    \mathcal{E}_F(w)$.
\end{proof}

\begin{definition}[Conflict-free Set]
    Let $F$ be a forest, $X \subseteq \{(\rho_F(v), \rho_F(u)) : (v, u) \in V
    \times V\}$ be a set of root pairs. Then $X$ is a conflict-free set in $F$
    if $(V, Y)$ is a forest.
\end{definition}

\begin{proposition}
    Let forest $F = (V, E)$ be a forest and let $X \subseteq V \times V$ be a
    conflict-free set in $F$ where $|X| = n$. Then defining the following forests:
    \begin{align*}
        F_0 &:= F \\
        F_{i} &:= (V, E_{i - 1} \cup \{(v_i, u_i)\}) \text{ for } (v_i, u_i) \in X \text{ and } 1 \leq i \leq n
    \end{align*}
    Then $F_n$ is a forest.
\end{proposition}

\begin{proof}
    Let forest $F = (V, E)$ be a forest, $X \subseteq V \times V$ be a
    conflict-free set in $F$. We will show that $F_n$ is a forest by induction
    on $i$.
    \begin{itemize}
        \item Base case: If $i = 0$ then $F_i = F_0 = F$ which is a forest.
        \item Induction hypothesis: Assume that $F_{i - 1}$ is a forest for all
        $1 \leq i < n$.  Let $(v_i, u_i) \in X$, we know that $v_i \neq v_j$ for
        all $(v_j, u_j) \in Y \backslash \{(v_i, u_i)\}$ since otherwise $(V,
        X)$ would not be a forest and $X$ would not be a conflict-free set in
        $F$. So $v_i$ will only have one parent in $F_i$ since it only appears
        once as a child in $(V, X)$. By definition all of the edges in $X$
        consists of roots in $F$, and since $(V, X)$ is a forest there are no
        cycles $y \centernot\leadsto y$ for all $y \in V$ in $F_i$. Hence $F_i$
        is a forest.
    \end{itemize}
    Thus by induction $F_n$ is a forest.
\end{proof}

\begin{proposition}
    Let forest $F$ be a forest and let $X \subseteq V \times V$ be a
    conflict-free set in $F$ where $|X| = n$. Then defining the following forests:
    \begin{align*}
        F_0 &:= F \\
        F_{i} &:= (V, E_{i - 1} \cup \{(v_i, u_i)\}) \text{ for } (v_i, u_i) \in X \text{ and } 1 \leq i \leq n \\
        G_0 &:= F \\
        G_{j} &:= (V, E_{i - 1} \cup \{(\rho_{G_{j - 1}}(v_j), \rho_{G_{j - 1}}(u_j))\}) \text{ for } (v_j, u_j) \in X \text{ and } 1 \leq j \leq n
    \end{align*}
    Then $F_{n} \cong G_{n}$.
\end{proposition}
\begin{proof}
    Let forest $F$ be a forest, $X \subseteq V \times V$ be a conflict-free set
    in $F$. We will show that $F_n \cong G_n$. We know that for some $(v_i, u_i)
    \in X$ then $v_i \neq y$ for all  $(y, w) \in X \backslash \{(v_i, u_i)\}$
    since otherwise $(V, X)$ would not be a forest and $X$ would not be a
    conflict-free set in $F$. So all edge set unions will only give a root $v_i$
    a new parent $u_i$ once. So $\rho_{F_n}(v_i) = \rho_{F_n}(u_i)$ and
    $\rho_{G_n}(u_i) = \rho_{G_n}(v_i)$ hence $v_i$ remains in the same tree in
    both $F_n$ and $G_n$. Since this holds for all $(v_i, u_i) \in X$ it follows
    that all elements in $V$ remains in the same tree in both $F_n$ and $G_n$.
    Hence $F_n \cong G_n$.
\end{proof}


\begin{definition}[Split]
    A split of a set $Z \subseteq V \times V$ into two sets $X, Z' \subseteq Y$
    such that $X$ is a conflict-free set in forest $F$ and $X = Y \backslash Z'$
    where: 
    \begin{align*}
        Y = \{(a, b) : (v, u) \in X \text{ where } \{a, b\} = \{\rho_F(v), \rho_F(u)\} \land a \neq b \}
    \end{align*}
\end{definition}

\begin{algorithm}[Conflict-free Tree Union]
    Let forest $F$ be a tree and let $Z \subseteq V \times V$ be a set of pairs
    of elements in $V$ that will be unioned in parallel. The conflict-free tree
    union algorithm is defined as:
    \begin{align*}
        & \kw{while} \: Z \neq \emptyset \: \kw{do} \\
        & \quad E \leftarrow \pi_2(F) \\
        & \quad \text{split } Z \text{ into } X, Z' \\
        & \quad \kw{parfor} \: (u, v) \in X \: \kw{do} \\
        & \quad \quad E \leftarrow E \cup \{(u, v)\} \\
        & \quad F \leftarrow (V, E) \\
        & \quad Z \leftarrow Z'
    \end{align*}
\end{algorithm}

\begin{definition}[Strongly Connected Graph]
    A strongly connected graph $G = (V, E)$ is a directed graph where for if $G'
    = (V, E \cup \{(u, v) : (v, u) \in E\})$. Then for all $u, v \in V$ it holds
    that $u \leadsto v$.
\end{definition}

\begin{proposition}[Maximum Edges in Conflict-free Set]
    Let $V$ be a set and $Z \subseteq V \times V$ be a set that will be split into
    a conflict-free set $X$ and a remainder set $Z'$. Then it is possible to
    find the maximum conflict-free set $X$ such that $|Z| = 0$ and $|X| = |V| -
    k$ where $k$ is the number of strongly connected components in the graph
    $G = (V, Z)$.
\end{proposition}

\begin{proof}
    By definition of a split then we can swap the components of any pair in $Z$.
    So if we consider the undirected graph $G' = (V, A)$ where $A = \{\{u, v\} :
    (u, v) \in Z\}$ then it has $k$ strongly connected components. Now by
    choosing some arbitrary tree which connects all vertices in each strongly
    connected component and directing the edges such that the tree has some
    arbitrary root in each component it will create a conflict-free set $X$
    where $|X| = |V| - k$ since each tree will have exactly one root that will
    not have a parent. And since all other edges in $Z$ will already be in some
    tree in $(V, X)$ it follows that $Z' = \emptyset$.
\end{proof}

\begin{definition}[Isolated Vertex]
    An \emph{isolated vertex} in a directed graph $G = (V, E)$ is a $v \in V$
    such that $(u, v) \notin E$ and $(u, v) \notin E$ for some $u \in V$.
\end{definition}

\begin{proposition}[Edge Swap Bound]
    Let $G = (V, E)$ be a directed graph without isolated vertices then:
    \begin{align*}
        |\{v : (v, u) \in E\}| < \frac{|V|}{2} \implies |\{u : (v, u) \in E\}| > \frac{|V|}{2} 
    \end{align*}
\end{proposition}
\begin{proof}
    Let $G = (V, E)$ without any isolated vertices and $|\{v : (v, u) \in E\}| < \frac{|V|}{2}$.
    Let $A = \{v : (v, u) \in E\}$, $B = \{u : (v, u) \in E\}$ and $C = B \backslash A$.
    By definition of $C$ we have $A \cap C = \emptyset$ so $|A| + |C| = |V|$ and since $|B| \geq |C|$ we can conclude that:
    \begin{align*}
        |B| \geq |C| = |V| - |A| > |V| - \frac{|V|}{2} = \frac{|V|}{2}
    \end{align*}
    Hence $|\{u : (v, u) \in E\}| > \frac{|V|}{2}$.
\end{proof}

\begin{definition}[Union-Find Structure]
    The union-find structure $U$ is a forest $U = (V, E)$ where the vertices $V
    = S$ for some set of elements $S$. The edges $E \subseteq V \times V$
    represent parent relations between elements in $S$ such that $(u, v) \in E$
    means that $u$ has parent $v$.
\end{definition}



\end{document}
